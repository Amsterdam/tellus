# -*- coding: utf-8 -*-
# Generated by Eelke on 2018-09-03 15:55
from __future__ import unicode_literals

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ("tellus_data", "0017_tellus_expanded_table"),
    ]

    operations = [
        migrations.RunSQL("""
            -- View: public.tellus_avg_hours_weekday

            DROP MATERIALIZED VIEW IF EXISTS public.tellus_avg_hours_weekday;

            CREATE TABLE public.tellus_avg_hours_weekday(
                id SERIAL PRIMARY KEY,
                id_tellus INT,
                tijd_van TIMESTAMP,
                werkdag INT,
                weekdag INT);
             INSERT INTO public.tellus_avg_hours_weekday (
                id_tellus,
                tijd_van,
                werkdag,
                weekdag)
              (SELECT
                b.id_tellus,
                b.tijd_van,
                ROUND(AVG(b.mw) filter (WHERE
                  DATE_PART('day', b.tijd_van) > 0 AND
                  DATE_PART('day', b.tijd_van) < 6), 0)::INT AS avg_werkdag,
                ROUND(AVG(b.mw), 0)::INT AS avg_weekdag
              FROM
                (SELECT
                   a.id_tellus,
                   a.tijd_van,
                   sum(a.sum_meetwaarde) as mw
                 FROM
                 (SELECT
                   id_tellus,
                   sum(meetwaarde) as sum_meetwaarde,
                   representatief,
                   tijd_van,
                   validatie
                 FROM tellus_data_expanded
                 WHERE representatief = 1 AND validatie = 1 --AND tellus_id = 2
                 GROUP BY
                   id_tellus,
                   representatief,
                   tijd_van,
                   tijd_tot,
                   validatie) as a
               GROUP BY id_tellus, tijd_van) as b
            GROUP BY
              id_tellus,
              tijd_van
            ORDER BY
              id_tellus,
              tijd_van);

            CREATE UNIQUE INDEX tellus_avg_hours_weekday_idx
              ON tellus_avg_hours_weekday (id_tellus, tijd_van);

            ALTER TABLE public.tellus_avg_hours_weekday
              OWNER TO tellus;
        """),
    ]
