# Generated by Django 2.1.5 on 2019-01-10 11:50

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('tellus_data', '0006_materialized_view_tellingen_Y_M_H_dag_type_length'),
    ]

    operations = [
        migrations.RunSQL("""
DROP MATERIALIZED VIEW IF EXISTS "tellus_data_year_month_hour_speed";
CREATE MATERIALIZED VIEW tellus_data_year_month_hour_speed
AS
  SELECT
       ROW_NUMBER() OVER (ORDER BY 1) as id,
       telling.tel_richting_id,
       snelheid.id as snelheids_interval_id,
       snelheid.label as snelheids_label,
       extract(YEAR from telling.tijd_van) as year,
       extract(MONTH from telling.tijd_van) as month,
       extract(HOUR from telling.tijd_van) as hour,
       (CASE WHEN extract(dow from telling.tijd_van) BETWEEN 0 AND 4 THEN 'Werkdag' ELSE 'Weekend' END) AS dag_type,
       SUM(telling.aantal) AS aantal,
       COUNT(DISTINCT extract(DAY from telling.tijd_van)) as aantal_dagen

  FROM tellus_data_telling telling
         LEFT JOIN tellus_data_snelheidsinterval snelheid
           ON telling.snelheids_interval_id = snelheid.id
  WHERE telling.representatief_categorie_id = 1
    AND telling.validatie_categorie_id = 1
  GROUP BY
           telling.tel_richting_id,
           year,
           month,
           hour,
           snelheid.id,
           dag_type
  ORDER BY
           telling.tel_richting_id,
           year,
           month,
           hour,
           snelheid.id

WITH DATA;
CREATE UNIQUE INDEX tellus_data_year_month_hour_speed_pkey ON tellus_data_year_month_hour_speed(id);
        """, """
DROP MATERIALIZED VIEW IF EXISTS "tellus_data_year_month_hour_speed";
        """),
    ]
