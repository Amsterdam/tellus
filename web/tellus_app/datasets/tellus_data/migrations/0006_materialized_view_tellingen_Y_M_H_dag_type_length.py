# Generated by Django 2.1.5 on 2019-01-10 11:00

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('tellus_data', '0005_auto_20190104_1322'),
    ]

    operations = [
        migrations.RunSQL("""
DROP MATERIALIZED VIEW IF EXISTS "tellus_data_year_month_hour_length";
CREATE MATERIALIZED VIEW tellus_data_year_month_hour_length
  AS
    SELECT
      ROW_NUMBER() OVER (ORDER BY 1) as id,
      richting.tellus_id,
      richting.richting as richting,
      lengte.id as lengte_interval_id,
      lengte.label as lengte_label,
      extract(YEAR from telling.tijd_van) as year,
      extract(MONTH from telling.tijd_van) as month,
      extract(HOUR from telling.tijd_van) as hour,
      (CASE WHEN extract(DAY from telling.tijd_van) NOT IN (0,6) THEN 'Werkdag' ELSE 'Weekend' END) AS dag_type,
      SUM(telling.aantal) AS aantal

    FROM tellus_data_telling telling
      LEFT join tellus_data_telrichting richting
        ON telling.tel_richting_id = richting.id
      LEFT JOIN tellus_data_lengteinterval lengte
        ON telling.lengte_interval_id = lengte.id

    GROUP BY
      richting.tellus_id,
      richting.richting,
      lengte.id,
      extract(YEAR from telling.tijd_van),
      extract(MONTH from telling.tijd_van),
      extract(HOUR from telling.tijd_van),
      dag_type
             
    ORDER BY
      richting.tellus_id,
      richting.richting,
      extract(YEAR from telling.tijd_van),
      extract(MONTH from telling.tijd_van),
      extract(HOUR from telling.tijd_van),
      lengte.label

WITH DATA;
CREATE UNIQUE INDEX tellus_data_year_month_hour_length_pkey ON tellus_data_year_month_hour_length(id);
        """, """
DROP MATERIALIZED VIEW IF EXISTS "tellus_data_year_month_hour_length";
        """),
    ]
