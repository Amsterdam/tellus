# Generated by Django 2.1.5 on 2019-01-10 11:00

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('tellus_data', '0005_auto_20190104_1322'),
    ]

    operations = [
        migrations.RunSQL("""
DROP MATERIALIZED VIEW IF EXISTS "tellus_data_year_month_hour_length";
CREATE MATERIALIZED VIEW tellus_data_year_month_hour_length
  AS
    SELECT
       ROW_NUMBER() OVER (ORDER BY 1) as id,
       telling.tel_richting_id,
       lengte.id as lengte_interval_id,
       lengte.label as lengte_label,
       extract(YEAR from telling.tijd_van) as year,
       extract(MONTH from telling.tijd_van) as month,
       extract(HOUR from telling.tijd_van) as hour,
       (CASE WHEN extract(dow from telling.tijd_van) BETWEEN 0 AND 4 THEN 'Werkdag' ELSE 'Weekend' END) AS dag_type,
       SUM(telling.aantal) AS aantal,
       COUNT(DISTINCT extract(DAY from telling.tijd_van)) as aantal_dagen

  FROM tellus_data_telling telling
         LEFT JOIN tellus_data_lengteinterval lengte
           ON telling.lengte_interval_id = lengte.id
  WHERE telling.representatief_categorie_id = 1
    AND telling.validatie_categorie_id = 1
  GROUP BY
           telling.tel_richting_id,
           year,
           month,
           hour,
           lengte.id,
           dag_type
  ORDER BY
           telling.tel_richting_id,
           year,
           month,
           hour,
           lengte.id

WITH DATA;
CREATE UNIQUE INDEX tellus_data_year_month_hour_length_pkey ON tellus_data_year_month_hour_length(id);
        """, """
DROP MATERIALIZED VIEW IF EXISTS "tellus_data_year_month_hour_length";
        """),
    ]
